name: Merge Rules from Multiple Sources

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'
  push:
    branches: [ main ]

jobs:
  merge-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Download and merge rules
        run: |
          # 创建合并脚本
          cat > merge_rules.py << 'EOF'
          #!/usr/bin/env python3
          import requests
          from datetime import datetime

          # 国内规则源列表
          china_rule_sources = [
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/China/China.list",
              "https://raw.githubusercontent.com/blueskycrb/ios_surge/refs/heads/main/cn.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/ChinaASN/ChinaASN.list"
          ]

          # 国外规则源列表
          proxy_rule_sources = [
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Telegram/Telegram.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/YouTube/YouTube.list",
              "https://raw.githubusercontent.com/blueskycrb/ios_surge/refs/heads/main/us.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/TikTok/TikTok.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Twitter/Twitter.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Google/Google.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Instagram/Instagram.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Facebook/Facebook.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/PayPal/PayPal.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Proxy/Proxy.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Loon/Epic/Epic.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Loon/Steam/Steam.list"
          ]

          # 支持的规则类型
          valid_rule_types = {
              'DOMAIN', 'DOMAIN-SUFFIX', 'DOMAIN-KEYWORD',
              'IP-CIDR', 'IP-CIDR6', 'USER-AGENT', 'PROCESS-NAME', 'IP-ASN'
          }

          def is_valid_rule(line):
              line = line.strip()
              if not line or line.startswith('#'):
                  return False
              parts = line.split(',')
              if len(parts) < 2:
                  return False
              return parts[0].strip() in valid_rule_types

          # ⭐ no-resolve 优先去重
          def dedupe_no_resolve_priority(rules):
              base_map = {}
              for rule in rules:
                  parts = rule.split(',')
                  if len(parts) < 2:
                      continue

                  rule_type = parts[0].strip()
                  value = parts[1].strip()
                  base_key = f"{rule_type},{value}"

                  if rule.endswith("no-resolve"):
                      base_map[base_key] = rule
                  else:
                      if base_key not in base_map:
                          base_map[base_key] = rule

              return set(base_map.values())

          def download_rules(url):
              try:
                  print(f"正在下载: {url}")
                  response = requests.get(url, timeout=30)
                  response.raise_for_status()
                  return response.text
              except Exception as e:
                  print(f"下载失败 {url}: {e}")
                  return None

          def parse_rules(content, source_url):
              rules = set()
              for line in content.split('\n'):
                  if is_valid_rule(line):
                      rules.add(line.strip())
              print(f"从 {source_url} 解析出 {len(rules)} 条规则")
              return rules

          def generate_rule_file(rules, filename, rule_type):
              sorted_rules = sorted(rules)
              output_lines = [
                  f"# NAME: {rule_type} Rules",
                  f"# DESCRIPTION: {rule_type} rules merged from multiple sources",
                  f"# UPDATED: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
                  "",
                  *sorted_rules
              ]
              with open(filename, 'w', encoding='utf-8') as f:
                  f.write("\n".join(output_lines))
              print(f"{rule_type} 规则生成完成！总共 {len(sorted_rules)} 条规则")

          # ⭐ 生成 Mihomo 格式的文件
          def generate_mihomo_format(rules, filename, is_china=True):
              formatted_rules = []
              suffix = 'DIRECT' if is_china else 'Proxy'
              for rule in rules:
                  parts = rule.split(',')
                  if len(parts) >= 2:
                      formatted_rules.append(f"{parts[0]},{parts[1]},{suffix}")
              with open(filename, 'w', encoding='utf-8') as f:
                  f.write("rules:\n")
                  for rule in formatted_rules:
                      f.write(f"  - {rule}\n")
              print(f"Mihomo 格式规则生成完成！文件名: {filename}, 总共 {len(formatted_rules)} 条规则")

          # 处理国内规则
          print("=== 开始处理国内规则 ===")
          china_rules = set()
          for source_url in china_rule_sources:
              content = download_rules(source_url)
              if content:
                  china_rules.update(parse_rules(content, source_url))

          # ⭐ 加入去重
          china_rules = dedupe_no_resolve_priority(china_rules)

          # 生成标准规则文件
          generate_rule_file(china_rules, 'china.list', 'China')

          # 生成 Mihomo 格式文件
          generate_mihomo_format(china_rules, 'china_mihomo.list', is_china=True)

          # 处理国外规则
          print("=== 开始处理国外规则 ===")
          proxy_rules = set()
          for source_url in proxy_rule_sources:
              content = download_rules(source_url)
              if content:
                  proxy_rules.update(parse_rules(content, source_url))

          # ⭐ 加入去重
          proxy_rules = dedupe_no_resolve_priority(proxy_rules)

          # 生成标准规则文件
          generate_rule_file(proxy_rules, 'proxy.list', 'Proxy')

          # 生成 Mihomo 格式文件
          generate_mihomo_format(proxy_rules, 'proxy_mihomo.list', is_china=False)

          print("所有规则处理完成！")
          EOF

          pip install requests
          python merge_rules.py

      - name: Check generated files
        run: |
          echo "检查生成的文件:"
          ls -la china.list proxy.list china_mihomo.list proxy_mihomo.list
          head -5 china.list
          head -5 proxy.list
          head -5 china_mihomo.list
          head -5 proxy_mihomo.list

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add china.list proxy.list china_mihomo.list proxy_mihomo.list
          if git diff --staged --quiet; then
            echo "没有检测到变化"
          else
            git commit -m "Auto-update rules"
            git push
          fi
