name: Merge Rules from Multiple Sources

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'
  push:
    branches: [ main ]

jobs:
  merge-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Download and merge rules
        run: |
          # 创建合并脚本
          cat > merge_rules.py << 'EOF'
          #!/usr/bin/env python3
          import requests
          from datetime import datetime

          # 国内规则源列表
          china_rule_sources = [
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Loon/China/China.list",
              "https://raw.githubusercontent.com/blueskycrb/ios_surge/refs/heads/main/cn.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Loon/PayPal/PayPal.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Loon/ChinaASN/ChinaASN.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Loon/Microsoft/Microsoft.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Loon/MicrosoftEdge/MicrosoftEdge.list"
          ]

          # 国外规则源列表
          proxy_rule_sources = [
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Loon/Telegram/Telegram.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Loon/YouTube/YouTube.list",
              "https://raw.githubusercontent.com/blueskycrb/ios_surge/refs/heads/main/us.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Loon/TikTok/TikTok.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Loon/Twitter/Twitter.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Loon/Google/Google.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Loon/Instagram/Instagram.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Loon/Facebook/Facebook.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Loon/Proxy/Proxy.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Loon/Epic/Epic.list",
              "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Loon/Steam/Steam.list"
          ]

          # 支持的规则类型
          valid_rule_types = {
              'DOMAIN', 'DOMAIN-SUFFIX', 'DOMAIN-KEYWORD',
              'IP-CIDR', 'IP-CIDR6', 'PROCESS-NAME'
          }

          def is_valid_rule(line):
              line = line.strip()
              if not line or line.startswith('#'):
                  return False
              parts = line.split(',')
              if len(parts) < 2:
                  return False
              return parts[0].strip() in valid_rule_types

          # ⭐ no-resolve 优先去重
          def dedupe_no_resolve_priority(rules):
              base_map = {}
              for rule in rules:
                  rule = format_ip_cidr(rule)  # 格式化 IP-CIDR 规则
                  parts = rule.split(',')
                  if len(parts) < 2:
                      continue

                  rule_type = parts[0].strip()
                  value = parts[1].strip()
                  base_key = f"{rule_type},{value}"

                  if rule.endswith("no-resolve"):
                      base_map[base_key] = rule.replace("no-resolve", "Proxy")  # 将no-resolve替换为Proxy
                  else:
                      if base_key not in base_map:
                          base_map[base_key] = rule

              return set(base_map.values())

          def format_ip_cidr(rule):
              """确保 IP-CIDR 规则的格式正确"""
              parts = rule.split(',')
              if len(parts) < 2:
                  return rule  # 不是有效规则，直接返回
              rule_type = parts[0].strip()
              value = parts[1].strip()

              # 对 IP-CIDR 进行格式化，如果是单个 IP，添加 /32 后缀
              if rule_type == 'IP-CIDR' and '/' not in value:
                  value = f"{value}/32"  # 添加 /32 后缀

              return f"{rule_type},{value}"

          def download_rules(url):
              try:
                  print(f"正在下载: {url}")
                  response = requests.get(url, timeout=30)
                  response.raise_for_status()
                  return response.text
              except Exception as e:
                  print(f"下载失败 {url}: {e}")
                  return None

          def parse_rules(content, source_url):
              rules = set()
              for line in content.split('\n'):
                  if is_valid_rule(line):
                      rules.add(line.strip())
              print(f"从 {source_url} 解析出 {len(rules)} 条规则")
              return rules

          def generate_rule_file(rules, filename, rule_type):
              sorted_rules = sorted(rules)
              output_lines = [
                  f"# NAME: {rule_type} Rules",
                  f"# DESCRIPTION: {rule_type} rules merged from multiple sources",
                  f"# UPDATED: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
                  "",
                  *sorted_rules
              ]
              with open(filename, 'w', encoding='utf-8') as f:
                  f.write("\n".join(output_lines))
              print(f"{rule_type} 规则生成完成！总共 {len(sorted_rules)} 条规则")

          def generate_mihomo_format(china_rules, proxy_rules):
              mihomo_rules = []

              # 国内规则加入 ,DIRECT
              for rule in china_rules:
                  if rule.startswith('USER-AGENT') or rule.startswith('IP-ASN'):
                      continue  # 不处理 USER-AGENT 和 IP-ASN 规则
                  mihomo_rules.append(f"{rule},DIRECT")

              # 国外规则加入 ,Proxy
              for rule in proxy_rules:
                  if rule.startswith('USER-AGENT') or rule.startswith('IP-ASN'):
                      continue  # 不处理 USER-AGENT 和 IP-ASN 规则
                  mihomo_rules.append(f"{rule},Proxy")

              # 合并国内和国外规则，保存为 mihomo.list
              with open("mihomo.list", "w", encoding="utf-8") as f:
                  f.write("rules:\n")
                  for rule in mihomo_rules:
                      f.write(f"  - {rule}\n")

              print("mihomo 格式规则生成完成！总共 {len(mihomo_rules)} 条规则")

          # 处理国内规则
          print("=== 开始处理国内规则 ===")
          china_rules = set()
          for source_url in china_rule_sources:
              content = download_rules(source_url)
              if content:
                  china_rules.update(parse_rules(content, source_url))

          # ⭐ 加入去重
          china_rules = dedupe_no_resolve_priority(china_rules)

          generate_rule_file(china_rules, 'china.list', 'China')

          # 处理国外规则
          print("=== 开始处理国外规则 ===")
          proxy_rules = set()
          for source_url in proxy_rule_sources:
              content = download_rules(source_url)
              if content:
                  proxy_rules.update(parse_rules(content, source_url))

          # ⭐ 加入去重
          proxy_rules = dedupe_no_resolve_priority(proxy_rules)

          generate_rule_file(proxy_rules, 'proxy.list', 'Proxy')

          # 生成 mihomo 格式的规则文件
          generate_mihomo_format(china_rules, proxy_rules)

          print("所有规则处理完成！")
          EOF

          pip install requests
          python merge_rules.py

      - name: Check generated files
        run: |
          echo "检查生成的文件:"
          ls -la china.list proxy.list mihomo.list
          head -5 china.list
          head -5 proxy.list
          head -5 mihomo.list

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add china.list proxy.list mihomo.list
          if git diff --staged --quiet; then
            echo "没有检测到变化"
          else
            git commit -m "Auto-update rules"
            git push
          fi
